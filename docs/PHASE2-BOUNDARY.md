# Phase 2 边界与范围文档

> **最后更新**: 2026-01-15
> **状态**: Phase 2 完成并明确边界

---

## 📋 Phase 2 范围定义

**Phase 2 重点**: 缠论计算引擎 + 图表可视化

### ✅ 范围内 (Phase 2)

#### 后端
1. **缠论计算引擎**
   - K线合并（包含处理）
   - 分型识别
   - 笔构建
   - 线段识别
   - 中枢识别
   - 买卖点识别
   - MACD 计算
   - 背驰检测（含成交量分析）

2. **API 接口**
   - `/api/chan/calculate` - 基础缠论计算
   - `/api/chan/calculate-full` - 完整计算（含买卖点）
   - `/api/chan/analysis` - 完整分析（含K线）
   - `/api/chan/fenxings` - 获取分型
   - `/api/chan/bis` - 获取笔
   - `/api/chan/xianduans` - 获取线段
   - `/api/chan/zhongshus` - 获取中枢
   - `/api/chan/trading-points` - 获取买卖点

3. **测试**
   - 所有缠论组件的单元测试
   - 计算引擎的集成测试
   - 买卖点的全面验证测试

#### 前端
1. **图表可视化**
   - 使用 ECharts 显示 K 线
   - 分型标记
   - 笔线叠加
   - 线段线叠加
   - 中枢框叠加
   - 买卖点标记（带标签）
   - 交互式图表控件

2. **图表分析页面**
   - 单标的分析界面
   - 实时数据更新
   - 不同缠论元素的图层开关
   - 标的和周期选择

### ❌ 范围外 (Phase 2) - 推迟到 Phase 3

#### 信号生成与分发
- **Signals.vue** - 当前使用基于价格涨跌幅的模拟信号
  - 基于缠论的真实信号生成
  - 信号推送通知
  - 告警系统
  - 信号历史和绩效跟踪

#### 多标的监控
- **Watchlist.vue** - 当前使用模拟信号
  - 批量标的监控
  - 自选列表告警
  - 分组管理与持久化
  - 实时多标的更新

#### API 优化
- **Markets.vue** - 当前使用单个 ticker 调用
  - 批量 ticker API 接口
  - 限流和节流
  - 请求聚合
  - WebSocket 实时更新

#### 高级功能
- 自动化交易策略
- 回测引擎
- 投资组合管理
- 绩效分析
- 移动端优化

---

## 🔧 Phase 2 实施状态

### ✅ 已完成

1. **后端缠论引擎**
   - 所有核心组件已实现
   - 成交量背驰已集成到决策逻辑
   - 买卖点生成包含类型、级别、置信度、原因
   - 全面的测试覆盖

2. **前端图表可视化**
   - 完整的图表渲染（所有缠论元素）
   - 交互式控件和图层开关
   - 实时数据集成

3. **API 集成**
   - 所有 Phase 2 接口功能正常
   - 前端成功调用后端 API
   - `marketCatalogApi` 导出问题已修复

### ⚠️ 已知限制（已标记为占位符）

1. **Signals.vue**
   - 使用价格涨跌幅作为模拟信号
   - 已用警告注释清晰标记
   - 包含 Phase 3 的 TODO 列表

2. **Watchlist.vue**
   - 使用价格涨跌幅作为模拟信号
   - 已用警告注释清晰标记
   - 包含 Phase 3 的 TODO 列表

3. **Markets.vue**
   - 使用 Promise.all 进行单个 ticker 调用
   - 已标记为占位符模式
   - 包含 Phase 3 优化的 TODO 列表

---

## 📊 Phase 2 交付物

### 后端交付物
- [x] 完整的缠论计算引擎
- [x] 所有 Phase 2 API 接口
- [x] 基于成交量的背驰检测
- [x] 带元数据的买卖点识别
- [x] 全面的测试套件

### 前端交付物
- [x] 交互式图表可视化
- [x] 带完整缠论叠加的图表分析页面
- [x] 包含所有 Phase 2 接口的 API 客户端
- [x] 图层开关控件
- [x] 实时数据更新

### 文档交付物
- [x] Phase 2 边界文档（本文件）
- [x] 占位符代码清晰标记
- [x] Phase 3 功能的 TODO 列表
- [x] CLAUDE.md 中的 API 文档

---

## 🎯 Phase 2 验收标准

### 功能需求

#### FR-2.1: K线处理
- [x] K线合并正确处理包含关系
- [x] 合并后的K线保持 OHLC 完整性
- [x] 方向变化正确检测

#### FR-2.2: 分型识别
- [x] 顶分型和底分型正确识别
- [x] 分型确认逻辑已实现
- [x] 分型位置在图表上准确

#### FR-2.3: 笔构建
- [x] 笔由交替的分型构建
- [x] 笔的方向正确交替
- [x] 笔的数量和价格范围准确

#### FR-2.4: 线段识别
- [x] 从笔序列识别线段
- [x] 线段确认逻辑已实现
- [x] 线段叠加正确渲染

#### FR-2.5: 中枢识别
- [x] 从重叠段识别中枢
- [x] 中枢的高/低/中心正确计算
- [x] 中枢框在图表上渲染

#### FR-2.6: 买卖点识别
- [x] 买卖点生成包含类型（BUY/SELL）
- [x] 买卖点包含级别（1-3）
- [x] 买卖点包含置信度（HIGH/MEDIUM/LOW）
- [x] 买卖点包含原因描述
- [x] 买卖点在测试中验证

#### FR-2.7: 背驰检测
- [x] 价格背驰检测
- [x] MACD 背驰计算
- [x] **成交量背驰集成到决策逻辑** ✅ (已修复)
- [x] 背驰强度计算

### 非功能需求

#### NFR-2.1: 性能
- [x] 计算在合理时间内完成
- [x] 图表流畅渲染所有图层
- [x] API 响应在可接受的延迟内

#### NFR-2.2: 测试
- [x] 所有组件的单元测试
- [x] 完整计算的集成测试
- [x] **全面的买卖点断言** ✅ (已增强)
  - 类型验证（BUY/SELL）
  - 级别验证（1-3）
  - 置信度验证（HIGH/MEDIUM/LOW）
  - 价格范围验证
  - 时间戳排序验证
  - 原因完整性验证

#### NFR-2.3: 代码质量
- [x] 清晰的关注点分离
- [x] 适当的错误处理
- [x] 全面的日志记录
- [x] **占位符代码清晰标记** ✅ (已完成)

---

## 🚧 Phase 3 规划

### 高优先级
1. **真实信号生成**
   - 将 Signals.vue 与 `/api/chan/trading-points` 集成
   - 替换模拟信号逻辑
   - 实现信号推送通知

2. **批量 API 优化**
   - 创建批量 ticker 接口
   - 实现限流
   - 添加请求聚合

3. **自选列表集成**
   - 将 Watchlist.vue 连接到真实信号
   - 实现多标的监控
   - 添加告警系统

### 中优先级
4. **WebSocket 实时更新**
   - 用 WebSocket 替换轮询
   - 实现高效的数据流
   - 添加重连逻辑

5. **信号历史与分析**
   - 存储信号历史
   - 跟踪信号绩效
   - 生成分析报告

### 低优先级
6. **高级功能**
   - 自动化交易策略
   - 回测引擎
   - 投资组合管理

---

## 🔍 已解决的问题

### 关键问题（已修复）
1. **marketCatalogApi 导出** ✅
   - **问题**: `marketCatalogApi` 已定义但未导出，导致构建错误
   - **位置**: `frontend/src/api/market.ts:215-235`
   - **修复**: 添加显式导出语句
   - **影响**: 前端现在可以成功构建

### 中等问题（已修复）
2. **成交量背驰未用于决策** ✅
   - **问题**: 成交量已计算但未用于背驰检测逻辑
   - **位置**: `backend/src/main/java/com/lucance/boot/backend/chan/DivergenceDetector.java:68-79`
   - **修复**: 将成交量条件添加到背驰检测
   - **影响**: 背驰检测现在需要价格 + MACD + 成交量确认

3. **买卖点测试不足** ✅
   - **问题**: 仅有非空断言，缺少类型/级别/置信度验证
   - **位置**: `backend/src/test/java/com/lucance/boot/backend/chan/ChanCalculationEngineTest.java:69`
   - **修复**: 添加全面的测试方法：
     - `testTradingPointsCompleteness()` - 验证所有字段
     - `testTradingPointsOrder()` - 验证时间戳排序
     - `testTradingPointsPriceRange()` - 验证价格在K线范围内
   - **影响**: 买卖点质量现在得到适当验证

### 低优先级问题（已记录）
4. **占位符信号逻辑** ✅
   - **问题**: Signals/Watchlist 使用价格涨跌幅作为模拟信号
   - **位置**:
     - `frontend/src/views/Signals.vue:325-364`
     - `frontend/src/views/Watchlist.vue:254-329`
   - **修复**: 添加清晰的警告注释和 Phase 3 TODO 列表
   - **影响**: 边界清晰传达，不会混淆范围

5. **低效的 API 调用模式** ✅
   - **问题**: Markets/Signals/Watchlist 使用 Promise.all 进行单个调用
   - **位置**:
     - `frontend/src/views/Markets.vue:355`
     - `frontend/src/views/Signals.vue:376`
     - `frontend/src/views/Watchlist.vue:329`
   - **修复**: 添加清晰的警告注释标记为占位符
   - **影响**: 已知限制已记录，Phase 3 优化已规划

---

## 📝 建议

### 给开发团队
1. **Phase 2 功能完整** - 所有核心缠论计算和可视化功能已实现并测试
2. **占位符代码清晰标记** - 不会混淆演示与生产代码
3. **Phase 3 范围定义明确** - 下一次迭代的清晰路线图

### 给 QA/测试
1. 运行全面的测试套件: `cd backend && mvn test`
2. 验证使用真实数据的图表可视化
3. 确认所有 Phase 2 API 接口功能正常
4. 验证买卖点包含所有必需字段

### 给产品/PM
1. Phase 2 实现了核心承诺：缠论计算 + 可视化
2. Signals/Watchlist 是 UI 演示，尚未功能化
3. Phase 3 应优先考虑真实信号集成
4. 在 Phase 3 之前考虑用户对图表 UX 的反馈

---

## 🎓 关键经验

### 做得好的地方
- 计算引擎和可视化之间的清晰分离
- 全面的测试覆盖早期发现问题
- 模块化架构允许轻松的 Phase 3 集成

### 可以改进的地方
- 更早明确阶段边界可以防止范围混淆
- 从一开始就更明确地标记占位符代码
- 更好地沟通 API 优化需求

### 技术债务
- 单个 ticker API 调用需要批量接口（Phase 3）
- 模拟信号逻辑应替换为真实信号（Phase 3）
- 实时更新需要 WebSocket 支持（Phase 3）

---

## 📞 联系与支持

关于 Phase 2 范围或 Phase 3 规划的问题：
- 首先查看本文档
- 查看 `CLAUDE.md` 了解整体架构
- 查看 `backend/CLAUDE.md` 了解后端详情
- 查看 `frontend/CLAUDE.md` 了解前端详情

---

**文档版本**: 1.0
**最后更新**: 2026-01-15
**下次审查**: Phase 3 启动前
